name: OWASP ZAP Full Scan (Authenticated)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Target URL to scan"
        required: true
        default: "https://app01.inceptionu-webinar.com"
      severity_threshold:
        description: "Lowest severity that should trigger enforcement"
        required: true
        type: choice
        options:
          - critical
          - high
          - medium
          - low
          - informational
        default: high
      enforcement:
        description: "Whether matching findings should warn or fail"
        required: true
        type: choice
        options:
          - fail
          - warn
        default: fail

permissions:
  contents: read
  issues: write

jobs:
  zap-full-auth:
    runs-on: ubuntu-latest
    env:
      SEVERITY_THRESHOLD: ${{ github.event.inputs.severity_threshold || 'high' }}
      ENFORCEMENT: ${{ github.event.inputs.enforcement || 'fail' }}
    steps:
      - name: Build auth header from secrets
        id: auth
        shell: bash
        env:
          ZAP_AUTH_BEARER_TOKEN: ${{ secrets.ZAP_AUTH_BEARER_TOKEN }}
          ZAP_AUTH_USERNAME: ${{ secrets.ZAP_AUTH_USERNAME }}
          ZAP_AUTH_PASSWORD: ${{ secrets.ZAP_AUTH_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -n "${ZAP_AUTH_BEARER_TOKEN:-}" ]; then
            echo "header=Authorization" >> "$GITHUB_OUTPUT"
            echo "value=Bearer ${ZAP_AUTH_BEARER_TOKEN}" >> "$GITHUB_OUTPUT"
            echo "Using bearer token authentication"
          elif [ -n "${ZAP_AUTH_USERNAME:-}" ] && [ -n "${ZAP_AUTH_PASSWORD:-}" ]; then
            BASIC_VALUE="$(printf '%s:%s' "$ZAP_AUTH_USERNAME" "$ZAP_AUTH_PASSWORD" | base64 | tr -d '\n')"
            echo "header=Authorization" >> "$GITHUB_OUTPUT"
            echo "value=Basic ${BASIC_VALUE}" >> "$GITHUB_OUTPUT"
            echo "Using basic authentication"
          else
            echo "No auth secrets found; scan will run unauthenticated"
            echo "header=" >> "$GITHUB_OUTPUT"
            echo "value=" >> "$GITHUB_OUTPUT"
          fi

      - name: ZAP Full Scan
        id: zap_scan
        continue-on-error: true
        uses: zaproxy/action-full-scan@v0.12.0
        env:
          ZAP_AUTH_HEADER: ${{ steps.auth.outputs.header }}
          ZAP_AUTH_HEADER_VALUE: ${{ steps.auth.outputs.value }}
          ZAP_AUTH_HEADER_SITE: ${{ github.event.inputs.target }}
        with:
          target: ${{ github.event.inputs.target }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_action: false

      - name: Enforce ZAP severity policy
        if: always()
        env:
          ZAP_STEP_OUTCOME: ${{ steps.zap_scan.outcome }}
        run: |
          node <<'NODE'
          const fs = require('fs');

          const rank = {
            informational: 0,
            low: 1,
            medium: 2,
            high: 3,
            critical: 4
          };

          const threshold = (process.env.SEVERITY_THRESHOLD || 'high').toLowerCase();
          const enforcement = (process.env.ENFORCEMENT || 'fail').toLowerCase();
          const zapOutcome = process.env.ZAP_STEP_OUTCOME;

          if (zapOutcome !== 'success') {
            console.error(`ZAP scan step did not complete successfully (outcome: ${zapOutcome}).`);
            process.exit(1);
          }

          if (!fs.existsSync('report_json.json')) {
            console.error('report_json.json not found; cannot enforce severity policy.');
            process.exit(1);
          }

          const report = JSON.parse(fs.readFileSync('report_json.json', 'utf8'));
          const sites = Array.isArray(report.site) ? report.site : [];
          const alerts = sites.flatMap((site) => (Array.isArray(site.alerts) ? site.alerts : []));

          const normalizeSeverity = (alert) => {
            const values = [alert?.risk, alert?.riskdesc, alert?.riskcode]
              .filter((v) => v !== undefined && v !== null)
              .map((v) => String(v).toLowerCase());

            if (values.some((v) => v.includes('critical') || v === '4')) return 'critical';
            if (values.some((v) => v.includes('high') || v === '3')) return 'high';
            if (values.some((v) => v.includes('medium') || v.includes('med') || v === '2')) return 'medium';
            if (values.some((v) => v.includes('low') || v === '1')) return 'low';
            return 'informational';
          };

          const counts = { critical: 0, high: 0, medium: 0, low: 0, informational: 0 };
          for (const alert of alerts) {
            const sev = normalizeSeverity(alert);
            counts[sev] += 1;
          }

          const thresholdRank = rank[threshold] ?? rank.high;
          const flagged = Object.entries(counts).reduce((acc, [sev, count]) => {
            return acc + (rank[sev] >= thresholdRank ? count : 0);
          }, 0);

          const summary = `ZAP findings by severity: critical=${counts.critical}, high=${counts.high}, medium=${counts.medium}, low=${counts.low}, informational=${counts.informational}. Threshold=${threshold}, enforcement=${enforcement}, matched=${flagged}.`;
          console.log(summary);

          if (flagged > 0) {
            if (enforcement === 'warn') {
              console.log(`::warning::${summary}`);
              process.exit(0);
            }

            console.error(`Policy violation: ${flagged} finding(s) matched threshold ${threshold}.`);
            process.exit(1);
          }
          NODE
